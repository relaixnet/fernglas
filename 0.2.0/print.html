<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Fernglas Manual</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="deployment/index.html"><strong aria-hidden="true">2.</strong> Deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="deployment/nixos.html"><strong aria-hidden="true">2.1.</strong> Using NixOS</a></li><li class="chapter-item expanded "><a href="deployment/container.html"><strong aria-hidden="true">2.2.</strong> Using Containers / Docker</a></li><li class="chapter-item expanded "><a href="deployment/manual/index.html"><strong aria-hidden="true">2.3.</strong> Manual Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="deployment/manual/backend.html"><strong aria-hidden="true">2.3.1.</strong> Backend</a></li><li class="chapter-item expanded "><a href="deployment/manual/frontend.html"><strong aria-hidden="true">2.3.2.</strong> Frontend and Reverse Proxy</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="configuration/index.html"><strong aria-hidden="true">3.</strong> Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="configuration/bmp-junos.html"><strong aria-hidden="true">3.1.</strong> Junos using BMP</a></li><li class="chapter-item expanded "><a href="configuration/bgp-bird2.html"><strong aria-hidden="true">3.2.</strong> bird2 using BGP</a></li></ol></li><li class="chapter-item expanded "><a href="appendix/index.html"><strong aria-hidden="true">4.</strong> Appendix</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="appendix/nixos-specialArgs-pattern.html"><strong aria-hidden="true">4.1.</strong> NixOS specialArgs pattern</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Fernglas Manual</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Fernglas is a looking glass for your network which is using BGP and BMP as data source. It provides a web frontend with serval nice features to discover and visualize. It is designed to prevent the necessity of the looking glass to access your routers and do querys on the cli.</p>
<p>The project is currently under heavy development, please consider this when deploying it.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deployment"><a class="header" href="#deployment">Deployment</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deploying-fernglas-using-nixos"><a class="header" href="#deploying-fernglas-using-nixos">Deploying fernglas using NixOS</a></h1>
<p>Requirements:</p>
<ul>
<li>Use NixOS with Nix flakes for your deploment</li>
<li>Be aware of <a href="deployment//appendix/nixos-specialArgs-pattern.html">the specialArgs pattern in NixOS with flakes</a> to get the <code>inputs</code> module arg</li>
</ul>
<p>Optional: Set up the binary cache to use prebuilt binaries from our CI</p>
<pre><code>$ nix run nixpkgs#cachix use wobcom-public
</code></pre>
<p>Add fernglas to your flake inputs:</p>
<pre><code class="language-nix">inputs.fernglas = {
  type = &quot;github&quot;;
  owner = &quot;wobcom&quot;;
  repo = &quot;fernglas&quot;;
};
</code></pre>
<p>Import the fernglas NixOS module and declare your configuration.</p>
<pre><code class="language-nix">{ inputs, ... }:

let
  bmpPort = 11019;
in {
  imports = [
    inputs.fernglas.nixosModules.default
  ];

  services.fernglas = {
    enable = true;
    settings = {
      api.bind = &quot;[::1]:3000&quot;;
      collectors = {
        my_bmp_collector = {
          collector_type = &quot;Bmp&quot;;
          bind = &quot;[::]:${toString bmpPort}&quot;;
          peers = {
            &quot;192.0.2.1&quot; = {};
          };
        };
      };
    };
  };

  networking.firewall.allowedTCPPorts = [ bmpPort ];
}
</code></pre>
<p>Configure a reverse proxy for the API and a webserver to serve the frontend.</p>
<pre><code class="language-nix">{ config, inputs, ... }:

{
  services.nginx = {
    enable = true;
    recommendedProxySettings = true;
    virtualHosts.&quot;lg.example.org&quot; = {
      enableACME = true;
      forceSSL = true;
      locations.&quot;/&quot;.root = inputs.fernglas.packages.${config.nixpkgs.hostPlatform.system}.fernglas-frontend;
      locations.&quot;/api/&quot;.proxyPass = &quot;http://${config.services.fernglas.settings.api.bind}&quot;;
    };
  };

  networking.firewall.allowedTCPPorts = [ 80 443 ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deploying-fernglas-using-oci-containers--docker"><a class="header" href="#deploying-fernglas-using-oci-containers--docker">Deploying fernglas using OCI Containers / Docker</a></h1>
<p>We have two different images. One image contains the UI, which is statically built and could be served from any other static webserver, i.e. nginx, apache, caddy. The other image contains the Fernglas software itself and is considered the backend. It exposes an HTTP API for the UI.</p>
<h2 id="prequesits"><a class="header" href="#prequesits">Prequesits</a></h2>
<ul>
<li>OCI Runtime
<ul>
<li>You need to have installed Docker, podman, or any similar container daemon that can run OCI containers provided by us</li>
</ul>
</li>
<li>You need to have a working reverse proxy setup
<ul>
<li>Fernglas only exposes HTTP. TLS and probably authentication needs to be handled by yourself. </li>
</ul>
</li>
<li>A Domain or Subdomain
<ul>
<li>Fernglas currently do not support path-based deployments, i.e. <code>example.org/fernglas</code>.</li>
</ul>
</li>
</ul>
<h2 id="fernglas-backend"><a class="header" href="#fernglas-backend">Fernglas Backend</a></h2>
<pre><code class="language-sh">docker pull ghcr.io/wobcom/fernglas:fernglas-0.2.1
</code></pre>
<p>You need to write a config file to specify Fernglas configuration. This needs to be put under <code>/config/config.yaml</code> in the standard configuration.
See the chapter on <a href="deployment/configuration/README.html">configuration</a> for more information on how to write the collectors configuration.</p>
<h2 id="fernglas-frontend"><a class="header" href="#fernglas-frontend">Fernglas Frontend</a></h2>
<pre><code class="language-sh">docker pull ghcr.io/wobcom/fernglas-frontend:fernglas-0.2.1
</code></pre>
<p>By setting <code>serve_static: true</code> in the config, the backend will also serve the bundled frontend files from the same webserver as the API.</p>
<p>You can take the fernglas-frontend image as base and serve the files with your own web server directly, if you want. The files need to be exposed at <code>/</code> of your domain, while the <code>/api/</code> path should be passed through to the API server.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="manual-setup"><a class="header" href="#manual-setup">Manual Setup</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backend"><a class="header" href="#backend">Backend</a></h1>
<p>Download the statically linked binaries and place them at <code>/usr/local/bin/</code>. Make them executable.</p>
<pre><code>$ sudo mkdir -p /usr/local/bin
$ wget -O- https://github.com/wobcom/fernglas/releases/download/fernglas-0.2.1/fernglas-static-0.2.1-x86-64-linux.tar.xz | sudo tar -C /usr/local/bin -xJ
</code></pre>
<p>File: /etc/fernglas/config.yml</p>
<pre><code class="language-yaml">api:
  bind: &quot;[::1]:3000&quot;
collectors:
  - collector_type: Bmp
    bind: &quot;[::]:11019&quot;
    peers:
      &quot;192.0.2.1&quot;: {}
</code></pre>
<p>systemd service with hardening options:</p>
<p>File: /etc/systemd/system/fernglas.service</p>
<pre><code class="language-ini">[Service]
ExecStart=/usr/local/bin/fernglas /etc/fernglas/config.yml
Environment=RUST_LOG=warn,fernglas=info
Restart=always
RestartSec=10
DynamicUser=true
DevicePolicy=closed
MemoryDenyWriteExecute=true
NoNewPrivileges=true
PrivateDevices=true
PrivateTmp=true
ProtectControlGroups=true
ProtectHome=true
ProtectSystem=strict
</code></pre>
<p>Optionally, add <code>AmbientCapabilities=CAP_NET_BIND_SERVICE</code> if your configuration requires binding to privileged ports.</p>
<p>Enable and start the service:</p>
<p><code>systemctl enable --now fernglas.service</code></p>
<p>Don't forget to open the appropriate firewall ports if necessary!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="frontend-and-reverse-proxy"><a class="header" href="#frontend-and-reverse-proxy">Frontend and Reverse Proxy</a></h1>
<p>To serve the bundled frontend files from the same web server as the API, set <code>serve_static: true</code> in the config.</p>
<p>Alternatively download the prebuilt frontend tar.
Extract it to <code>/usr/local/share/fernglas-frontend</code>.</p>
<pre><code>$ sudo mkdir -p /usr/local/share/fernglas-frontend
$ wget -O- https://github.com/wobcom/fernglas/releases/download/fernglas-0.2.1/fernglas-frontend-0.2.1.tar.xz | sudo tar -C /usr/local/share/fernglas-frontend -xJ
</code></pre>
<p>Set up your reverse proxy / webserver.
A configuration for nginx might look like this:</p>
<pre><code>server {
	# we expect that you know how to set up a secure web server on your platform

	location / {
		root /usr/local/share/fernglas-frontend;
	}
	location /api/ {
		proxy_pass http://[::1]:3000; # match the api.bind setting from your fernglas config
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Host $host;
		proxy_set_header X-Forwarded-Server $host;
	}
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<p>The example configuration uses port <code>3000</code> and <code>11019</code> to expose the API and collect the BMP data stream. You can change those ports, if needed,
but you need to expose 11019 to an IP address reachable from your router, probably bind this port to <code>[::]:11019</code> and check for outside reachability.
Note: You also need to specify the IP addresses of possible peers in the config file to ensure no unauthorized person is steaming a BMP stream to your machine.</p>
<p>To hook up routers to your looking glass, you will have to configure either a BMP (BGP Monitoring Protocol) or BGP session between your router and the looking glass.</p>
<p>For both the BGP and BMP collectors, multiple instances can be created (listening on different ports, etc.) and per-peer configuration can be provided based on the client IP.</p>
<p>If multiple collectors collect data with the same hostname (as reported by BMP or BGP peer, or set in <code>name_override</code>), the data will be combined in the frontend. This can be used to build complex views of the Pre/Post Policy Adj-In and LocRib tables using multiple BGP sessions.<br />
If using BMP, everything should 'just work'.</p>
<pre><code class="language-yml">
collectors:

  # BMP collector that listens on port 11019 and accepts all incoming connections
  - collector_type: Bmp
    bind: &quot;[::]:11019&quot;
    default_peer_config: {}

  # BMP collector that listens on the privileged port 11020 and accepts incoming connections only from select client IPs
  - collector_type: Bmp
    bind: &quot;[::]:11020&quot;
    peers:
      &quot;192.0.2.1&quot;: {}
      &quot;192.0.2.2&quot;:
        name_override: router02.example.org

  # BGP collector that listens on port 1179 and accept all  incoming connections
  - collector_type: Bgp
    bind: &quot;[::]:1179&quot;
    default_peer_config:
      asn: 64496
      router_id: 192.0.2.100

  # BGP collector that listens on the privileged port 179 and accepts incoming connections only from select client IPs
  - collector_type: Bgp
    bind: &quot;[::]:179&quot;
    peers:
      &quot;192.0.2.1&quot;:
        asn: 64496
	router_id: 192.0.2.100
      &quot;192.0.2.2&quot;:
        asn: 64496
	router_id: 192.0.2.100
        name_override: router02.example.org
</code></pre>
<p>Valid options for BMP peer config:</p>
<ul>
<li><code>name_override</code> (optional): Use this string instead of the <code>sys_name</code> advertised in the BMP initiation message</li>
</ul>
<p>Valid options for BGP peer config:</p>
<ul>
<li><code>asn</code> (required): AS Number advertised to peer</li>
<li><code>router_id</code> (required): Router ID advertised to peer</li>
<li><code>name_override</code> (optional): Use this string instead of the hostname advertised in the <a href="https://www.ietf.org/archive/id/draft-walton-bgp-hostname-capability-02.txt">BGP hostname capability</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="junos-using-bmp"><a class="header" href="#junos-using-bmp">Junos using BMP</a></h1>
<pre><code>routing-options {
    bmp {
        station looking-glass {
            station-address 2001:db8::100;
            station-port 11019;
            local-address 2001:db8::1;
            connection-mode active;
            route-monitoring {
                pre-policy { exclude-non-feasible; }
                post-policy { exclude-non-eligible; }
                loc-rib;
            }
        }
    }
}
</code></pre>
<p>Be aware that in some older Junos versions the BMP implementation is buggy and causes memory leaks in the routing process.</p>
<div class="table-wrapper"><table><thead><tr><th>Tested Junos Release</th><th>Known Issues</th></tr></thead><tbody>
<tr><td>20.2R3-S3.6</td><td>❌ <a href="https://prsearch.juniper.net/PR1526061">PR1526061</a> BGP Monitoring Protocols may not releases IO buffer correctly</td></tr>
<tr><td>21.4R3-S2.3</td><td>❌ <a href="https://prsearch.juniper.net/PR1713444">PR1713444</a> The rpd process may crash when BMP socket write fails or blocks</td></tr>
<tr><td>21.4R3-S4.9</td><td>✅ None</td></tr>
<tr><td>22.2R3.15</td><td>✅ None</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="bird2-using-bgp"><a class="header" href="#bird2-using-bgp">bird2 using BGP</a></h1>
<pre><code>protocol bgp bgp_lg from bgp_all {
  local as 64496;
  source address 2001:db8::1;
  neighbor 2001:db8::100 port 1179 as 64496;
  multihop 64;
  rr client;
  advertise hostname on;

  ipv6 {
    add paths tx;
    import filter { reject; };
    export filter { accept; };
    next hop keep;
  };
  ipv4 {
    add paths tx;
    import filter { reject; };
    export filter { accept; };
    next hop keep;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="appendix"><a class="header" href="#appendix">Appendix</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nixos-specialargs-pattern"><a class="header" href="#nixos-specialargs-pattern">NixOS specialArgs pattern</a></h1>
<h3 id="borrowed-from-here"><a class="header" href="#borrowed-from-here">Borrowed from <a href="https://pad.yuka.dev/s/DpS0wJ4R6#">here</a></a></h3>
<p>problem: you want to get the home-manager nixos module from the home-manager flake into a nixos config:</p>
<p>the home-manager documentation says this: https://nix-community.github.io/home-manager/index.html#sec-flakes-nixos-module</p>
<pre><code class="language-nix">{
  description = &quot;NixOS configuration&quot;;

  inputs = {
    nixpkgs.url = &quot;github:nixos/nixpkgs/nixos-unstable&quot;;
    home-manager.url = &quot;github:nix-community/home-manager&quot;;
    home-manager.inputs.nixpkgs.follows = &quot;nixpkgs&quot;;
  };

  outputs = inputs@{ nixpkgs, home-manager, ... }: {
    nixosConfigurations = {
      hostname = nixpkgs.lib.nixosSystem {
        system = &quot;x86_64-linux&quot;;
        modules = [
          ./configuration.nix
          home-manager.nixosModules.home-manager
          {
            home-manager.useGlobalPkgs = true;
            home-manager.useUserPackages = true;
            home-manager.users.jdoe = import ./home.nix;

            # Optionally, use home-manager.extraSpecialArgs to pass
            # arguments to home.nix
          }
        ];
      };
    };
  };
}
</code></pre>
<p>I find this ugly, because it forces to have the home manager include (<code>modules = [ ... home-manager.nixosModules.home-manager ...  ];</code>) in the flake.nix, because only there the inputs or home-manager attrset is in scope</p>
<p>In &quot;old&quot; configurations, with niv or plain fetchTarball, you would have done this in the configuration.nix of the respective host(, or a common.nix, if it should be included on all hosts)
<code>imports = [ &lt;home-manager/nixos&gt; ];</code>
actually <em>anywhere</em> in <em>any</em> nixos config file</p>
<p>The solution is the following:</p>
<p>flake.nix</p>
<pre><code class="language-nix">
{
  description = &quot;NixOS configuration&quot;;

  inputs = {
    nixpkgs.url = &quot;github:nixos/nixpkgs/nixos-unstable&quot;;
    home-manager.url = &quot;github:nix-community/home-manager&quot;;
    home-manager.inputs.nixpkgs.follows = &quot;nixpkgs&quot;;
  };

  outputs = inputs@{ nixpkgs, ... }: {
    nixosConfigurations = {
      hostname = nixpkgs.lib.nixosSystem {
        system = &quot;x86_64-linux&quot;;
        specialArgs = { inherit inputs; };
        modules = [
          ./configuration.nix
        ];
      };
    };
  };
}
</code></pre>
<p>configuration.nix</p>
<pre><code class="language-nix">{ pkgs, lib, config, inputs, ... }:

{
  networking.hostName = &quot;foo&quot;;
  [...]

  imports = [
    inputs.home-manager.nixosModules.home-manager
  ];
  home-manager.useGlobalPkgs = true;
  home-manager.useUserPackages = true;
  home-manager.users.jdoe = import ./home.nix;
}
</code></pre>
<p>specialArgs means, the <code>inputs</code> attrset is now available in the module args in every nixos module. just add it to the function parameters anywhere you need it, like you do it with <code>pkgs</code>, <code>lib</code> and <code>config</code>.
specialArgs also means that in contrast to <code>_module.args</code> this parameter to the module system is fixed, and can not be changed by nixos modules themselves. this prevents infinite recursions when using stuff from the inputs attrset in nixos module imports (which is exactly what we want to do).</p>
<p>and like this using flake inputs in nixos configs becomes much easier and more natural. in many cases you can rewrite &quot;old&quot; configs 1:1 to this new pattern without moving the includes to flake.nix</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
